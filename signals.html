// main.ts
import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
import { Bot, InlineKeyboard, webhookCallback } from "https://deno.land/x/grammy@v1.23.0/mod.ts";

// ========== BOT CONFIG ==========
const BOT_TOKEN = Deno.env.get("BOT_TOKEN");
if (!BOT_TOKEN) throw new Error("BOT_TOKEN not set");
const bot = new Bot(BOT_TOKEN);

// Store subscribed users in memory (for deploy, consider KV DB)
const subscribers = new Set<number>();

// ========== SIGNAL GENERATOR ==========
function generateSignal() {
  const pairs = [
    "ðŸ‡ºðŸ‡¸ USD/JPY ðŸ‡¯ðŸ‡µ","ðŸ‡ªðŸ‡º EUR/USD ðŸ‡ºðŸ‡¸","ðŸ‡¬ðŸ‡§ GBP/USD ðŸ‡ºðŸ‡¸","ðŸ‡¦ðŸ‡º AUD/USD ðŸ‡ºðŸ‡¸","ðŸ‡¨ðŸ‡­ USD/CHF ðŸ‡¨ðŸ‡­",
    "ðŸ‡¨ðŸ‡¦ USD/CAD ðŸ‡¨ðŸ‡¦","ðŸ‡³ðŸ‡¿ NZD/USD ðŸ‡ºðŸ‡¸","XAU/USD (Gold)","BTC/USDT (Crypto)","ETH/USDT (Crypto)"
  ];

  const pair = pairs[Math.floor(Math.random() * pairs.length)];
  const side = Math.random() > 0.5 ? "BUY" : "SELL";

  const now = new Date();
  const utc = now.toISOString().replace("T", " ").substring(0, 19) + " UTC";

  return (
    `âš¡ï¸ OTC Signal\n` +
    `ðŸ“Š Market: ${pair}\n` +
    `ðŸ“Œ Type: ${side}\n` +
    `ðŸŽ¯ Entry: ${now.toLocaleTimeString()}\n` +
    `â±ï¸ Expiry: 1 Minute (Quotex)\n` +
    `ðŸ•’ Time: ${now.toLocaleString("en-GB", { timeZone: "Asia/Dhaka" })} BST\n` +
    `ðŸŒ UTC: ${utc}\n` +
    `ðŸ”– Tags: #Quotex #OTC #Binary`
  );
}

// ========== BOT COMMANDS ==========
bot.command("start", async (ctx) => {
  subscribers.add(ctx.chat.id); // add to subscribers
  const kb = new InlineKeyboard().text("ðŸ“¡ Get Signal", "get-signal");
  await ctx.reply("âœ… Welcome! You are subscribed to Auto Signals.\nClick below for instant signal:", { reply_markup: kb });
});

bot.command("help", (ctx) =>
  ctx.reply("Commands:\n/start - Subscribe\n/help - Show help\n")
);

// Button handler (manual signal)
bot.callbackQuery("get-signal", async (ctx) => {
  const signal = generateSignal();
  await ctx.answerCallbackQuery();
  await ctx.reply(signal);
});

// ========== AUTO BROADCAST ==========
async function autoBroadcast() {
  const signal = generateSignal();
  for (const chatId of subscribers) {
    try {
      await bot.api.sendMessage(chatId, signal);
    } catch (err) {
      console.error("Send failed:", err);
    }
  }
}

// Run broadcast every 2 minutes
setInterval(autoBroadcast, 2 * 60 * 1000);

// ========== DEPLOY WEBHOOK ==========
const handleUpdate = webhookCallback(bot, "std/http");
serve(async (req: Request) => {
  const url = new URL(req.url);

  if (req.method === "POST" && url.pathname === "/webhook") {
    return await handleUpdate(req);
  }

  return new Response("Bot running with auto-broadcast...", { status: 200 });
});